name: Build cURL for Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Android SDK and NDK
      uses: nexus-actions/setup-android@v3
      with:
        ndk-version: 26.1.10909125
        components: "platform-tools,build-tools;34.0.0"

    - name: Download cURL source
      run: |
        curl -L https://curl.se/download/curl-8.13.0.tar.gz -o curl.tar.gz
        tar -xzf curl.tar.gz
        mv curl-* curl-src
        
    - name: Set up environment
      run: |
        echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV
        
    - name: Build for Android ABIs
      run: |
        cd curl-src
        ./build_android.sh
        
    - name: Package artifacts
      run: |
        mkdir -p artifacts
        cp -r curl-src/android/* artifacts/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: curl-android-libs
        path: artifacts/
        retention-days: 7